(function(g){function H(m){for(var o=0,s=0,e=0,f=m.length-3;e<f;e+=2){o+=m[e];s+=m[e+1]}m=(m.length-2)*2;return[o/m<<0,s/m<<0]}function xa(m){var o=m.length/2,s=new ya(o),e=0,f=o-1,i,n,l,y,B=[],I=[],D=[];for(s[e]=s[f]=1;f;){n=0;for(i=e+1;i<f;i++){l=m[i*2];var J=m[i*2+1],z=m[e*2],w=m[e*2+1],O=m[f*2],T=m[f*2+1],u=O-z,q=T-w,p=void 0;if(u!==0||q!==0){p=((l-z)*u+(J-w)*q)/(u*u+q*q);if(p>1){z=O;w=T}else if(p>0){z+=u*p;w+=q*p}}u=l-z;q=J-w;l=u*u+q*q;if(l>n){y=i;n=l}}if(n>2){s[y]=1;B.push(e);I.push(y);B.push(y);
I.push(f)}e=B.pop();f=I.pop()}for(i=0;i<o;i++)s[i]&&D.push(m[i*2],m[i*2+1]);return D}var za=za||Array,ya=ya||Array,$=Math,Ka=$.exp,La=$.log,Aa=$.tan,Ma=$.atan,ea=$.min,ra=$.max,oa=g.document,P=function(){function m(e,f,i){if(i<0)i+=1;if(i>1)i-=1;if(i<1/6)return e+(f-e)*6*i;if(i<0.5)return f;if(i<2/3)return e+(f-e)*(2/3-i)*6;return e}function o(e,f,i,n){this.r=e;this.g=f;this.b=i;this.a=arguments.length<4?1:n}var s=o.prototype;s.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+
")"};s.adjustLightness=function(e){var f=P.toHSLA(this);f.l*=e;f.l=Math.min(1,Math.max(0,f.l));var i,n;if(f.s===0)e=i=n=f.l;else{n=f.l<0.5?f.l*(1+f.s):f.l+f.s-f.l*f.s;var l=2*f.l-n;e=m(l,n,f.h+1/3);i=m(l,n,f.h);n=m(l,n,f.h-1/3)}return new P(e*255<<0,i*255<<0,n*255<<0,f.a)};s.adjustAlpha=function(e){return new P(this.r,this.g,this.b,this.a*e)};o.parse=function(e){e+="";if(~e.indexOf("#")){e=e.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new P(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],
16),e[4]?parseInt(e[4],16)/255:1)}if(e=e.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new P(parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),e[4]?parseFloat(e[5],10):1)};o.toHSLA=function(e){var f=e.r/255,i=e.g/255,n=e.b/255,l=Math.max(f,i,n),y=Math.min(f,i,n),B,I=(l+y)/2,D;if(l===y)B=y=0;else{D=l-y;y=I>0.5?D/(2-l-y):D/(l+y);switch(l){case f:B=(i-n)/D+(i<n?6:0);break;case i:B=(n-f)/D+2;break;case n:B=(f-i)/D+4;break}B/=6}return{h:B,s:y,l:I,a:e.a}};return o}();(function(){var m=
Math,o=m.sin,s=m.cos,e=m.tan,f=m.asin,i=m.atan2,n=m.PI,l=180/n,y=357.5291/l,B=0.98560028/l,I=1.9148/l,D=0.02/l,J=3.0E-4/l,z=102.9372/l,w=23.45/l,O=280.16/l,T=360.9856235/l;return function(u,q,p){p=-p/l;q=q/l;u=u.valueOf()/864E5-0.5+2440588;var E=y+B*(u-2451545),K=I*o(E)+D*o(2*E)+J*o(3*E);K=E+z+K+n;E=f(o(K)*o(w));K=i(o(K)*s(w),s(K));p=O+T*(u-2451545)-p-K;return{altitude:f(o(q)*o(E)+s(q)*s(E)*s(p)),azimuth:i(o(p),s(p)*o(q)-e(E)*s(q))-n/2}}})();var fa=Math.PI,Ba=fa/2,Na=fa/4,Oa=180/fa,Pa=256,sa=14,ga=
"latitude",ha="longitude",W=0,S=1,Q=2,U=3,Ca=4,ia=5,ja=6;g.OSMBuildings=function(m){function o(a,c){var b={};a/=E;c/=E;b[ga]=c<=0?90:c>=1?-90:Oa*(2*Ma(Ka(fa*(1-2*c)))-Ba);b[ha]=(a===1?1:(a%1+1)%1)*360-180;return b}function s(a,c){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return c[d]})}function e(a,c){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&c(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);
return b}function f(){if(!(!ta||p<sa)){var a=o(u-O,q-T),c=o(u+z+O,q+w+T);K&&K.abort();K=e(s(ta,{w:a[ha],n:a[ga],e:c[ha],s:c[ga],z:p}),i)}}function i(a){var c,b,d,j=[],h,k=h=0;pa=sa;I(p);K=null;if(!(!a||a.meta.z!==p)){d=a.meta;b=a.data;if(F&&A&&F.z===d.z){h=F.x-d.x;k=F.y-d.y;a=0;for(c=A.length;a<c;a++)j[a]=A[a][Q][0]+h+","+(A[a][Q][1]+k)}F=d;A=[];a=0;for(c=b.length;a<c;a++){d=[];if(!(b[a][S]>ka)){h=xa(b[a][Q]);if(!(h.length<8)){d[Q]=h;d[Ca]=H(h);d[W]=ea(b[a][W],ka);d[S]=b[a][S];h=d[Q][0]+","+d[Q][1];
d[ia]=!(j&&~j.indexOf(h));d[U]=[];d[ja]=[];A.push(d)}}}D()}}function n(a,c){var b=[],d,j,h,k,x,v,r,M,t,G=ua-p;d=0;for(j=a.length;d<j;d++){x=a[d];M=x[S]>>G;if(!(M>ka)){v=x[Q];t=new za(v.length);h=0;for(k=v.length-1;h<k;h+=2){r=v[h+1];var N=ea(1,ra(0,0.5-La(Aa(Na+Ba*v[h]/180))/fa/2));r={x:(r/360+0.5)*E<<0,y:N*E<<0};t[h]=r.x;t[h+1]=r.y}t=xa(t);if(!(t.length<8)){k=[];k[Q]=t;k[Ca]=H(t);k[W]=ea(x[W]>>G,ka);k[S]=M;k[ia]=c;k[U]=x[U];k[ja]=[];for(h=0;h<3;h++)if(k[U][h])k[ja][h]=k[U][h].adjustAlpha(R)+"";b.push(k)}}}return b}
function l(a,c){if(typeof a==="object")B(a,!c);else{var b=oa.documentElement,d=oa.createElement("script");g.jsonpCallback=function(j){delete g.jsonpCallback;b.removeChild(d);B(j,!c)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function y(a,c,b){if(b===undefined)b=[];var d,j,h,k=a[0]?a:a.features,x,v,r,M,t,G=c?1:0,N=c?0:1;if(k){d=0;for(a=k.length;d<a;d++)y(k[d],c,b);return b}if(a.type==="Feature"){x=a.geometry;d=a.properties}if(x.type==="Polygon")v=[x.coordinates];
if(x.type==="MultiPolygon")v=x.coordinates;if(v){c=d.height;if(d.color||d.wallColor)M=P.parse(d.color||d.wallColor);if(d.roofColor)t=P.parse(d.roofColor);d=0;for(a=v.length;d<a;d++){k=v[d][0];r=[];j=x=0;for(h=k.length;j<h;j++){r.push(k[j][G],k[j][N]);x+=c||k[j][2]||0}if(x){j=[];h=Q;var la=void 0,X=void 0,Da=void 0,Ea=void 0,Fa=0,Y=void 0,Ga=void 0;Y=0;for(Ga=r.length-3;Y<Ga;Y+=2){la=r[Y];X=r[Y+1];Da=r[Y+2];Ea=r[Y+3];Fa+=la*Ea-Da*X}if((Fa/2>0?"CW":"CCW")==="CW")r=r;else{la=[];for(X=r.length-2;X>=0;X-=
2)la.push(r[X],r[X+1]);r=la}j[h]=r;j[W]=x/k.length<<0;j[U]=[M||null,M?M.adjustLightness(0.8):null,t?t:M?M.adjustLightness(1.2):Z];b.push(j)}}}return b}function B(a,c){if(a){ma=y(a,c);pa=0;I(p);F={n:90,w:-180,s:-90,e:180,x:0,y:0,z:p};A=n(ma,true);D()}else{ma=null;J()}}function I(a){var c,b,d;p=a;E=Pa<<p;a=p;c=pa;b=ua;a=ea(ra(a,c),b);R=1-ea(ra(0+(a-c)/(b-c)*0.4,0),0.4);Ha=V.adjustAlpha(R)+"";Ia=qa.adjustAlpha(R)+"";na=Z.adjustAlpha(R)+"";if(A){a=0;for(c=A.length;a<c;a++){d=A[a];d[ja]=[];for(b=0;b<3;b++)if(d[U][b])d[ja][b]=
d[U][b].adjustAlpha(R)+""}}}function D(){clearInterval(va);aa=0;va=setInterval(function(){aa+=0.1;if(aa>1){clearInterval(va);aa=1;for(var a=0,c=A.length;a<c;a++)A[a][ia]=0}J()},33)}function J(){C.clearRect(0,0,z,w);C.fillStyle="rgba(0,0,0)";C.fillRect(0,0,z,w);if(!(!F||!A||p<pa||wa)){var a,c,b,d,j,h,k,x,v,r=u-F.x,M=q-F.y,t,G,N;a=0;for(c=A.length;a<c;a++){j=A[a];G=false;h=j[Q];t=[];b=0;for(d=h.length-1;b<d;b+=2){t[b]=k=h[b]-r;t[b+1]=v=h[b+1]-M;G||(G=k>0&&k<z&&v>0&&v<w)}if(G){b=j[ia]?j[W]*aa:j[W];k=
ba/(ba-b);if(j[S]){b=j[ia]?j[S]*aa:j[S];x=ba/(ba-b)}h=[];b=0;for(d=t.length-3;b<d;b+=2){v=t[b];N=t[b+1];G={x:(v-ca)*k+ca<<0,y:(N-da)*k+da<<0};C.strokeStyle=na;if(j[S]){N={x:(v-ca)*x+ca<<0,y:(N-da)*x+da<<0};v=N.x;N=N.y}C.beginPath();C.moveTo(v,N);C.lineTo(G.x,G.y);C.stroke();h[b]=G.x;h[b+1]=G.y}C.strokeStyle=na;if(h.length){C.beginPath();C.moveTo(h[0],h[1]);j=2;for(t=h.length;j<t;j+=2)C.lineTo(h[j],h[j+1]);C.closePath();C.stroke()}}}}}var z=0,w=0,O=0,T=0,u=0,q=0,p,E,K,C,ta,V=new P(200,190,180),qa=
V.adjustLightness(0.8),Z=V.adjustLightness(1.2),Ha=V+"",Ia=qa+"",na=Z+"",ma,F,A,aa=1,va,R=1,pa=sa,ua=20,ka,ca,da,ba,wa,Ja={container:null,items:[],init:function(a){var c=this.container=oa.createElement("DIV");c.style.pointerEvents="none";c.style.position="absolute";c.style.left=0;c.style.top=0;C=this.create();a.appendChild(c);return c},create:function(){var a=oa.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";
a.style.left=0;a.style.top=0;var c=a.getContext("2d");c.lineCap="round";c.lineJoin="round";c.lineWidth=2;try{c.mozImageSmoothingEnabled=false}catch(b){}this.items.push(a);this.container.appendChild(a);return c},setSize:function(a,c){for(var b=this.items,d=0,j=b.length;d<j;d++){b[d].width=a;b[d].height=c}}};this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){V=P.parse(a.color||a.wallColor);Ha=V.adjustAlpha(R)+"";qa=V.adjustLightness(0.8);Ia=qa.adjustAlpha(R)+"";Z=V.adjustLightness(1.2);
na=Z.adjustAlpha(R)+""}if(a.roofColor){Z=P.parse(a.roofColor);na=Z.adjustAlpha(R)+""}J();return this};this.geoJSON=function(a,c){l(a,c);return this};this.setCamOffset=function(a,c){ca=O+a;da=w+c};this.setMaxZoom=function(a){ua=a};this.setDate=function(){return this};this.appendTo=function(a){return Ja.init(a)};this.loadData=f;this.onMoveEnd=function(){var a=o(u,q),c=o(u+z,q+w);J();if(F&&(a[ga]>F.n||a[ha]<F.w||c[ga]<F.s||c[ha]>F.e))f()};this.onZoomEnd=function(a){wa=false;I(a.zoom);if(ma){A=n(ma);
J()}else{J();f()}};this.onZoomStart=function(){wa=true;J()};this.setOrigin=function(a,c){u=a;q=c};this.setSize=function(a,c){z=a;w=c;O=z/2<<0;T=w/2<<0;ca=O;da=w;ba=z/((window.devicePixelRatio||1)*1.5)/Aa(45)<<0;Ja.setSize(z,w);ka=ba-50};this.setZoom=I;this.render=J;ta=m};g.OSMBuildings.VERSION="0.1.8a";g.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,container:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(g){L.Util.setOptions(this,g)},onMove:function(){var g=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-g.x,this.lastY-g.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var g=L.DomUtil.getPosition(this.map._mapPane),H=this.map.getPixelOrigin();this.lastX=g.x;this.lastY=g.y;this.container.style.left=-g.x+
"px";this.container.style.top=-g.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(H.x-g.x,H.y-g.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var g=L.DomUtil.getPosition(this.map._mapPane),H=this.map.getPixelOrigin();this.osmb.setOrigin(H.x-g.x,H.y-g.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(g){g.addLayer(this);return this},onAdd:function(g){this.map=
g;g=this.map._panes.overlayPane;if(this.osmb)g.appendChild(this.container);else{this.osmb=new OSMBuildings(this.options.url);this.container=this.osmb.appendTo(g);this.osmb.maxZoom=this.map._layersMaxZoom}g=L.DomUtil.getPosition(this.map._mapPane);var H=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(H.x-g.x,H.y-g.y);this.osmb.setZoom(this.map._zoom);this.container.style.left=-g.x+"px";this.container.style.top=-g.y+"px";this.map.on({move:this.onMove,
moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(g){g.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);g.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.container.parentNode.removeChild(this.container)},geoJSON:function(g,H){return this.osmb.geoJSON(g,H)},setStyle:function(g){return this.osmb.setStyle(g)},
setDate:function(g){return this.osmb.setDate(g)}});
