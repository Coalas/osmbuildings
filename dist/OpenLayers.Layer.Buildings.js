(function(k){function J(m){for(var o=0,s=0,e=0,f=m.length-3;e<f;e+=2){o+=m[e];s+=m[e+1]}m=(m.length-2)*2;return[o/m<<0,s/m<<0]}function N(m){var o=m.length/2,s=new za(o),e=0,f=o-1,i,n,l,w,C=[],K=[],D=[];for(s[e]=s[f]=1;f;){n=0;for(i=e+1;i<f;i++){l=m[i*2];var L=m[i*2+1],P=m[e*2],y=m[e*2+1],E=m[f*2],Q=m[f*2+1],z=E-P,p=Q-y,u=void 0;if(z!==0||p!==0){u=((l-P)*z+(L-y)*p)/(z*z+p*p);if(u>1){P=E;y=Q}else if(u>0){P+=z*u;y+=p*u}}z=l-P;p=L-y;l=z*z+p*p;if(l>n){w=i;n=l}}if(n>2){s[w]=1;C.push(e);K.push(w);C.push(w);
K.push(f)}e=C.pop();f=K.pop()}for(i=0;i<o;i++)s[i]&&D.push(m[i*2],m[i*2+1]);return D}var ma=ma||Array,za=za||Array,ba=Math,Ka=ba.exp,La=ba.log,Aa=ba.tan,Ma=ba.atan,da=ba.min,ta=ba.max,na=k.document,R=function(){function m(e,f,i){if(i<0)i+=1;if(i>1)i-=1;if(i<1/6)return e+(f-e)*6*i;if(i<0.5)return f;if(i<2/3)return e+(f-e)*(2/3-i)*6;return e}function o(e,f,i,n){this.r=e;this.g=f;this.b=i;this.a=arguments.length<4?1:n}var s=o.prototype;s.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<
0,this.a.toFixed(2)].join(",")+")"};s.adjustLightness=function(e){var f=R.toHSLA(this);f.l*=e;f.l=Math.min(1,Math.max(0,f.l));var i,n;if(f.s===0)e=i=n=f.l;else{n=f.l<0.5?f.l*(1+f.s):f.l+f.s-f.l*f.s;var l=2*f.l-n;e=m(l,n,f.h+1/3);i=m(l,n,f.h);n=m(l,n,f.h-1/3)}return new R(e*255<<0,i*255<<0,n*255<<0,f.a)};s.adjustAlpha=function(e){return new R(this.r,this.g,this.b,this.a*e)};o.parse=function(e){e+="";if(~e.indexOf("#")){e=e.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new R(parseInt(e[1],16),parseInt(e[2],
16),parseInt(e[3],16),e[4]?parseInt(e[4],16)/255:1)}if(e=e.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new R(parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),e[4]?parseFloat(e[5],10):1)};o.toHSLA=function(e){var f=e.r/255,i=e.g/255,n=e.b/255,l=Math.max(f,i,n),w=Math.min(f,i,n),C,K=(l+w)/2,D;if(l===w)C=w=0;else{D=l-w;w=K>0.5?D/(2-l-w):D/(l+w);switch(l){case f:C=(i-n)/D+(i<n?6:0);break;case i:C=(n-f)/D+2;break;case n:C=(f-i)/D+4;break}C/=6}return{h:C,s:w,l:K,a:e.a}};return o}();
(function(){var m=Math,o=m.sin,s=m.cos,e=m.tan,f=m.asin,i=m.atan2,n=m.PI,l=180/n,w=357.5291/l,C=0.98560028/l,K=1.9148/l,D=0.02/l,L=3.0E-4/l,P=102.9372/l,y=23.45/l,E=280.16/l,Q=360.9856235/l;return function(z,p,u){u=-u/l;p=p/l;z=z.valueOf()/864E5-0.5+2440588;var v=w+C*(z-2451545),M=K*o(v)+D*o(2*v)+L*o(3*v);M=v+P+M+n;v=f(o(M)*o(y));M=i(o(M)*s(y),s(M));u=E+Q*(z-2451545)-u-M;return{altitude:f(o(p)*o(v)+s(p)*s(v)*s(u)),azimuth:i(o(u),s(u)*o(p)-e(v)*s(p))-n/2}}})();var ea=Math.PI,Ba=ea/2,Na=ea/4,Oa=180/
ea,Pa=256,ua=14,fa="latitude",ga="longitude",V=0,U=1,S=2,W=3,Ca=4,ha=5,ia=6;k.OSMBuildings=function(m){function o(a,c){var b={};a/=M;c/=M;b[fa]=c<=0?90:c>=1?-90:Oa*(2*Ma(Ka(ea*(1-2*c)))-Ba);b[ga]=(a===1?1:(a%1+1)%1)*360-180;return b}function s(a,c){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return c[d]})}function e(a,c){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&c(JSON.parse(b.responseText))};b.open("GET",
a);b.send(null);return b}function f(){if(!(!va||v<ua)){var a=o(p-Q,u-z),c=o(p+y+Q,u+E+z);oa&&oa.abort();oa=e(s(va,{w:a[ga],n:a[fa],e:c[ga],s:c[fa],z:v}),i)}}function i(a){var c,b,d,g=[],h,j=h=0;pa=ua;K(v);oa=null;if(!(!a||a.meta.z!==v)){d=a.meta;b=a.data;if(F&&A&&F.z===d.z){h=F.x-d.x;j=F.y-d.y;a=0;for(c=A.length;a<c;a++)g[a]=A[a][S][0]+h+","+(A[a][S][1]+j)}F=d;A=[];a=0;for(c=b.length;a<c;a++){d=[];if(!(b[a][U]>ja)){h=N(b[a][S]);if(!(h.length<8)){d[S]=h;d[Ca]=J(h);d[V]=da(b[a][V],ja);d[U]=b[a][U];
h=d[S][0]+","+d[S][1];d[ha]=!(g&&~g.indexOf(h));d[W]=[];d[ia]=[];A.push(d)}}}D()}}function n(a,c){var b=[],d,g,h,j,x,q,r,O,t,G=wa-v;d=0;for(g=a.length;d<g;d++){x=a[d];O=x[U]>>G;if(!(O>ja)){q=x[S];t=new ma(q.length);h=0;for(j=q.length-1;h<j;h+=2){r=q[h+1];var H=da(1,ta(0,0.5-La(Aa(Na+Ba*q[h]/180))/ea/2));r={x:(r/360+0.5)*M<<0,y:H*M<<0};t[h]=r.x;t[h+1]=r.y}t=N(t);if(!(t.length<8)){j=[];j[S]=t;j[Ca]=J(t);j[V]=da(x[V]>>G,ja);j[U]=O;j[ha]=c;j[W]=x[W];j[ia]=[];for(h=0;h<3;h++)if(j[W][h])j[ia][h]=j[W][h].adjustAlpha(T)+
"";b.push(j)}}}return b}function l(a,c){if(typeof a==="object")C(a,!c);else{var b=na.documentElement,d=na.createElement("script");k.jsonpCallback=function(g){delete k.jsonpCallback;b.removeChild(d);C(g,!c)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function w(a,c,b){if(b===undefined)b=[];var d,g,h,j=a[0]?a:a.features,x,q,r,O,t,G=c?1:0,H=c?0:1;if(j){d=0;for(a=j.length;d<a;d++)w(j[d],c,b);return b}if(a.type==="Feature"){x=a.geometry;d=a.properties}if(x.type==="Polygon")q=
[x.coordinates];if(x.type==="MultiPolygon")q=x.coordinates;if(q){c=d.height;if(d.color||d.wallColor)O=R.parse(d.color||d.wallColor);if(d.roofColor)t=R.parse(d.roofColor);d=0;for(a=q.length;d<a;d++){j=q[d][0];r=[];g=x=0;for(h=j.length;g<h;g++){r.push(j[g][G],j[g][H]);x+=c||j[g][2]||0}if(x){g=[];h=S;var B=void 0,Z=void 0,Da=void 0,Ea=void 0,Fa=0,$=void 0,Ga=void 0;$=0;for(Ga=r.length-3;$<Ga;$+=2){B=r[$];Z=r[$+1];Da=r[$+2];Ea=r[$+3];Fa+=B*Ea-Da*Z}if((Fa/2>0?"CW":"CCW")==="CW")r=r;else{B=[];for(Z=r.length-
2;Z>=0;Z-=2)B.push(r[Z],r[Z+1]);r=B}g[h]=r;g[V]=x/j.length<<0;g[W]=[O||null,O?O.adjustLightness(0.8):null,t?t:O?O.adjustLightness(1.2):aa];b.push(g)}}}return b}function C(a,c){if(a){ka=w(a,c);pa=0;K(v);F={n:90,w:-180,s:-90,e:180,x:0,y:0,z:v};A=n(ka,true);D()}else{ka=null;L()}}function K(a){var c,b,d;v=a;M=Pa<<v;a=v;c=pa;b=wa;a=da(ta(a,c),b);T=1-da(ta(0+(a-c)/(b-c)*0.4,0),0.4);Ha=X.adjustAlpha(T)+"";Ia=qa.adjustAlpha(T)+"";la=aa.adjustAlpha(T)+"";if(A){a=0;for(c=A.length;a<c;a++){d=A[a];d[ia]=[];for(b=
0;b<3;b++)if(d[W][b])d[ia][b]=d[W][b].adjustAlpha(T)+""}}}function D(){clearInterval(xa);ca=0;xa=setInterval(function(){ca+=0.1;if(ca>1){clearInterval(xa);ca=1;for(var a=0,c=A.length;a<c;a++)A[a][ha]=0}L()},33)}function L(){I.clearRect(0,0,y,E);if(!(!F||!A||v<pa||ya)){var a,c,b,d,g,h,j,x,q,r=p-F.x,O=u-F.y,t,G,H,B;a=0;for(c=A.length;a<c;a++){g=A[a];G=false;h=g[S];t=[];b=0;for(d=h.length-1;b<d;b+=2){t[b]=j=h[b]-r;t[b+1]=q=h[b+1]-O;G||(G=j>0&&j<y&&q>0&&q<E)}if(G){b=g[ha]?g[V]*ca:g[V];j=Y/(Y-b);if(g[U]){b=
g[ha]?g[U]*ca:g[U];x=Y/(Y-b)}h=[];b=0;for(d=t.length-3;b<d;b+=2){q=t[b];H=t[b+1];G=P(q,H,j);B=P(q,H,Y/(Y-40));B=I.createLinearGradient(q,H,B.x,B.y);B.addColorStop(0,"rgba(64,64,64,0.7)");B.addColorStop(0.4,"rgba(50,70,50,0.8)");B.addColorStop(0.6,"rgba(50,120,100,0.9)");B.addColorStop(0.8,"rgb(170,50,150)");B.addColorStop(1,"rgb(255,0,0)");I.strokeStyle=B;if(g[U]){H=P(q,H,x);q=H.x;H=H.y}I.beginPath();I.moveTo(q,H);I.lineTo(G.x,G.y);I.stroke();h[b]=G.x;h[b+1]=G.y}g=g[V]/40;la=g<0.2?"rgba(64,64,64,0.7)":
g<0.4?"rgba(50,70,50,0.8)":g<0.6?"rgba(50,120,100,0.9)":g<0.8?"rgb(170,50,150)":"rgb(255,0,0)";I.strokeStyle=la;if(h.length){I.beginPath();I.moveTo(h[0],h[1]);g=2;for(t=h.length;g<t;g+=2)I.lineTo(h[g],h[g+1]);I.closePath();I.stroke()}}}}}function P(a,c,b){return{x:(a-ra)*b+ra<<0,y:(c-sa)*b+sa<<0}}var y=0,E=0,Q=0,z=0,p=0,u=0,v,M,oa,I,va,X=new R(200,190,180),qa=X.adjustLightness(0.8),aa=X.adjustLightness(1.2),Ha=X+"",Ia=qa+"",la=aa+"",ka,F,A,ca=1,xa,T=1,pa=ua,wa=20,ja,ra,sa,Y,ya,Ja={container:null,
items:[],init:function(a){var c=this.container=na.createElement("DIV");c.style.pointerEvents="none";c.style.position="absolute";c.style.left=0;c.style.top=0;I=this.create();a.appendChild(c);return c},create:function(){var a=na.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";a.style.left=0;a.style.top=0;var c=a.getContext("2d");c.lineCap="round";c.lineJoin="round";c.lineWidth=1;try{c.mozImageSmoothingEnabled=false}catch(b){}this.items.push(a);
this.container.appendChild(a);return c},setSize:function(a,c){for(var b=this.items,d=0,g=b.length;d<g;d++){b[d].width=a;b[d].height=c}}};this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){X=R.parse(a.color||a.wallColor);Ha=X.adjustAlpha(T)+"";qa=X.adjustLightness(0.8);Ia=qa.adjustAlpha(T)+"";aa=X.adjustLightness(1.2);la=aa.adjustAlpha(T)+""}if(a.roofColor){aa=R.parse(a.roofColor);la=aa.adjustAlpha(T)+""}L();return this};this.geoJSON=function(a,c){l(a,c);return this};this.setCamOffset=
function(a,c){ra=Q+a;sa=E+c};this.setMaxZoom=function(a){wa=a};this.setDate=function(){return this};this.appendTo=function(a){return Ja.init(a)};this.loadData=f;this.onMoveEnd=function(){var a=o(p,u),c=o(p+y,u+E);L();if(F&&(a[fa]>F.n||a[ga]<F.w||c[fa]<F.s||c[ga]>F.e))f()};this.onZoomEnd=function(a){ya=false;K(a.zoom);if(ka){A=n(ka);L()}else{L();f()}};this.onZoomStart=function(){ya=true;L()};this.setOrigin=function(a,c){p=a;u=c};this.setSize=function(a,c){y=a;E=c;Q=y/2<<0;z=E/2<<0;ra=Q;sa=E;Y=y/((window.devicePixelRatio||
1)*1.5)/Aa(45)<<0;Ja.setSize(y,E);ja=Y-50};this.setZoom=K;this.render=L;va=m};k.OSMBuildings.VERSION="0.1.8a";k.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:false,alwaysInRange:true,dxSum:0,dySum:0,initialize:function(k){k=k||{};k.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize(this.name,k)},setOrigin:function(){var k=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),J=this.map.resolution,N=this.maxExtent;this.osmb.setOrigin(Math.round((k.lon-N.left)/J),Math.round((N.top-
k.lat)/J))},setMap:function(k){this.map||OpenLayers.Layer.prototype.setMap(k);if(!this.osmb){this.osmb=new OSMBuildings(this.options.url);this.container=this.osmb.appendTo(this.div)}this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()},removeMap:function(k){this.container.parentNode.removeChild(this.container);OpenLayers.Layer.prototype.removeMap(k)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize();this.osmb.onResize({width:this.map.size.w,
height:this.map.size.h})},moveTo:function(k,J,N){k=OpenLayers.Layer.prototype.moveTo(k,J,N);if(!N){N=parseInt(this.map.layerContainerDiv.style.left,10);var ma=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-N+"px";this.div.style.top=-ma+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);J?this.osmb.onZoomEnd({zoom:this.map.zoom}):this.osmb.onMoveEnd();return k},moveByPx:function(k,J){this.dxSum+=k;this.dySum+=J;var N=OpenLayers.Layer.prototype.moveByPx(k,
J);this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();return N},geoJSON:function(k,J){return this.osmb.geoJSON(k,J)},setStyle:function(k){return this.osmb.setStyle(k)},setDate:function(k){return this.osmb.setDate(k)}});
