(function(k){function H(m){for(var o=0,s=0,e=0,f=m.length-3;e<f;e+=2){o+=m[e];s+=m[e+1]}m=(m.length-2)*2;return[o/m<<0,s/m<<0]}function K(m){var o=m.length/2,s=new ya(o),e=0,f=o-1,h,n,l,y,B=[],I=[],D=[];for(s[e]=s[f]=1;f;){n=0;for(h=e+1;h<f;h++){l=m[h*2];var J=m[h*2+1],z=m[e*2],w=m[e*2+1],O=m[f*2],T=m[f*2+1],u=O-z,q=T-w,p=void 0;if(u!==0||q!==0){p=((l-z)*u+(J-w)*q)/(u*u+q*q);if(p>1){z=O;w=T}else if(p>0){z+=u*p;w+=q*p}}u=l-z;q=J-w;l=u*u+q*q;if(l>n){y=h;n=l}}if(n>2){s[y]=1;B.push(e);I.push(y);B.push(y);
I.push(f)}e=B.pop();f=I.pop()}for(h=0;h<o;h++)s[h]&&D.push(m[h*2],m[h*2+1]);return D}var oa=oa||Array,ya=ya||Array,$=Math,Ja=$.exp,Ka=$.log,za=$.tan,La=$.atan,ea=$.min,sa=$.max,pa=k.document,P=function(){function m(e,f,h){if(h<0)h+=1;if(h>1)h-=1;if(h<1/6)return e+(f-e)*6*h;if(h<0.5)return f;if(h<2/3)return e+(f-e)*(2/3-h)*6;return e}function o(e,f,h,n){this.r=e;this.g=f;this.b=h;this.a=arguments.length<4?1:n}var s=o.prototype;s.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+
")"};s.adjustLightness=function(e){var f=P.toHSLA(this);f.l*=e;f.l=Math.min(1,Math.max(0,f.l));var h,n;if(f.s===0)e=h=n=f.l;else{n=f.l<0.5?f.l*(1+f.s):f.l+f.s-f.l*f.s;var l=2*f.l-n;e=m(l,n,f.h+1/3);h=m(l,n,f.h);n=m(l,n,f.h-1/3)}return new P(e*255<<0,h*255<<0,n*255<<0,f.a)};s.adjustAlpha=function(e){return new P(this.r,this.g,this.b,this.a*e)};o.parse=function(e){e+="";if(~e.indexOf("#")){e=e.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new P(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],
16),e[4]?parseInt(e[4],16)/255:1)}if(e=e.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new P(parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),e[4]?parseFloat(e[5],10):1)};o.toHSLA=function(e){var f=e.r/255,h=e.g/255,n=e.b/255,l=Math.max(f,h,n),y=Math.min(f,h,n),B,I=(l+y)/2,D;if(l===y)B=y=0;else{D=l-y;y=I>0.5?D/(2-l-y):D/(l+y);switch(l){case f:B=(h-n)/D+(h<n?6:0);break;case h:B=(n-f)/D+2;break;case n:B=(f-h)/D+4;break}B/=6}return{h:B,s:y,l:I,a:e.a}};return o}();(function(){var m=
Math,o=m.sin,s=m.cos,e=m.tan,f=m.asin,h=m.atan2,n=m.PI,l=180/n,y=357.5291/l,B=0.98560028/l,I=1.9148/l,D=0.02/l,J=3.0E-4/l,z=102.9372/l,w=23.45/l,O=280.16/l,T=360.9856235/l;return function(u,q,p){p=-p/l;q=q/l;u=u.valueOf()/864E5-0.5+2440588;var E=y+B*(u-2451545),L=I*o(E)+D*o(2*E)+J*o(3*E);L=E+z+L+n;E=f(o(L)*o(w));L=h(o(L)*s(w),s(L));p=O+T*(u-2451545)-p-L;return{altitude:f(o(q)*o(E)+s(q)*s(E)*s(p)),azimuth:h(o(p),s(p)*o(q)-e(E)*s(q))-n/2}}})();var fa=Math.PI,Aa=fa/2,Ma=fa/4,Na=180/fa,Oa=256,ta=14,ga=
"latitude",ha="longitude",W=0,S=1,Q=2,U=3,Ba=4,ia=5,ja=6;k.OSMBuildings=function(m){function o(a,c){var b={};a/=E;c/=E;b[ga]=c<=0?90:c>=1?-90:Na*(2*La(Ja(fa*(1-2*c)))-Aa);b[ha]=(a===1?1:(a%1+1)%1)*360-180;return b}function s(a,c){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return c[d]})}function e(a,c){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&c(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);
return b}function f(){if(!(!ua||p<ta)){var a=o(u-O,q-T),c=o(u+z+O,q+w+T);L&&L.abort();L=e(s(ua,{w:a[ha],n:a[ga],e:c[ha],s:c[ga],z:p}),h)}}function h(a){var c,b,d,i=[],g,j=g=0;qa=ta;I(p);L=null;if(!(!a||a.meta.z!==p)){d=a.meta;b=a.data;if(F&&A&&F.z===d.z){g=F.x-d.x;j=F.y-d.y;a=0;for(c=A.length;a<c;a++)i[a]=A[a][Q][0]+g+","+(A[a][Q][1]+j)}F=d;A=[];a=0;for(c=b.length;a<c;a++){d=[];if(!(b[a][S]>ka)){g=K(b[a][Q]);if(!(g.length<8)){d[Q]=g;d[Ba]=H(g);d[W]=ea(b[a][W],ka);d[S]=b[a][S];g=d[Q][0]+","+d[Q][1];
d[ia]=!(i&&~i.indexOf(g));d[U]=[];d[ja]=[];A.push(d)}}}D()}}function n(a,c){var b=[],d,i,g,j,x,v,r,M,t,G=va-p;d=0;for(i=a.length;d<i;d++){x=a[d];M=x[S]>>G;if(!(M>ka)){v=x[Q];t=new oa(v.length);g=0;for(j=v.length-1;g<j;g+=2){r=v[g+1];var N=ea(1,sa(0,0.5-Ka(za(Ma+Aa*v[g]/180))/fa/2));r={x:(r/360+0.5)*E<<0,y:N*E<<0};t[g]=r.x;t[g+1]=r.y}t=K(t);if(!(t.length<8)){j=[];j[Q]=t;j[Ba]=H(t);j[W]=ea(x[W]>>G,ka);j[S]=M;j[ia]=c;j[U]=x[U];j[ja]=[];for(g=0;g<3;g++)if(j[U][g])j[ja][g]=j[U][g].adjustAlpha(R)+"";b.push(j)}}}return b}
function l(a,c){if(typeof a==="object")B(a,!c);else{var b=pa.documentElement,d=pa.createElement("script");k.jsonpCallback=function(i){delete k.jsonpCallback;b.removeChild(d);B(i,!c)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function y(a,c,b){if(b===undefined)b=[];var d,i,g,j=a[0]?a:a.features,x,v,r,M,t,G=c?1:0,N=c?0:1;if(j){d=0;for(a=j.length;d<a;d++)y(j[d],c,b);return b}if(a.type==="Feature"){x=a.geometry;d=a.properties}if(x.type==="Polygon")v=[x.coordinates];
if(x.type==="MultiPolygon")v=x.coordinates;if(v){c=d.height;if(d.color||d.wallColor)M=P.parse(d.color||d.wallColor);if(d.roofColor)t=P.parse(d.roofColor);d=0;for(a=v.length;d<a;d++){j=v[d][0];r=[];i=x=0;for(g=j.length;i<g;i++){r.push(j[i][G],j[i][N]);x+=c||j[i][2]||0}if(x){i=[];g=Q;var la=void 0,X=void 0,Ca=void 0,Da=void 0,Ea=0,Y=void 0,Fa=void 0;Y=0;for(Fa=r.length-3;Y<Fa;Y+=2){la=r[Y];X=r[Y+1];Ca=r[Y+2];Da=r[Y+3];Ea+=la*Da-Ca*X}if((Ea/2>0?"CW":"CCW")==="CW")r=r;else{la=[];for(X=r.length-2;X>=0;X-=
2)la.push(r[X],r[X+1]);r=la}i[g]=r;i[W]=x/j.length<<0;i[U]=[M||null,M?M.adjustLightness(0.8):null,t?t:M?M.adjustLightness(1.2):Z];b.push(i)}}}return b}function B(a,c){if(a){ma=y(a,c);qa=0;I(p);F={n:90,w:-180,s:-90,e:180,x:0,y:0,z:p};A=n(ma,true);D()}else{ma=null;J()}}function I(a){var c,b,d;p=a;E=Oa<<p;a=p;c=qa;b=va;a=ea(sa(a,c),b);R=1-ea(sa(0+(a-c)/(b-c)*0.4,0),0.4);Ga=V.adjustAlpha(R)+"";Ha=ra.adjustAlpha(R)+"";na=Z.adjustAlpha(R)+"";if(A){a=0;for(c=A.length;a<c;a++){d=A[a];d[ja]=[];for(b=0;b<3;b++)if(d[U][b])d[ja][b]=
d[U][b].adjustAlpha(R)+""}}}function D(){clearInterval(wa);aa=0;wa=setInterval(function(){aa+=0.1;if(aa>1){clearInterval(wa);aa=1;for(var a=0,c=A.length;a<c;a++)A[a][ia]=0}J()},33)}function J(){C.clearRect(0,0,z,w);C.fillStyle="rgba(0,0,0)";C.fillRect(0,0,z,w);if(!(!F||!A||p<qa||xa)){var a,c,b,d,i,g,j,x,v,r=u-F.x,M=q-F.y,t,G,N;a=0;for(c=A.length;a<c;a++){i=A[a];G=false;g=i[Q];t=[];b=0;for(d=g.length-1;b<d;b+=2){t[b]=j=g[b]-r;t[b+1]=v=g[b+1]-M;G||(G=j>0&&j<z&&v>0&&v<w)}if(G){b=i[ia]?i[W]*aa:i[W];j=
ba/(ba-b);if(i[S]){b=i[ia]?i[S]*aa:i[S];x=ba/(ba-b)}g=[];b=0;for(d=t.length-3;b<d;b+=2){v=t[b];N=t[b+1];G={x:(v-ca)*j+ca<<0,y:(N-da)*j+da<<0};C.strokeStyle=na;if(i[S]){N={x:(v-ca)*x+ca<<0,y:(N-da)*x+da<<0};v=N.x;N=N.y}C.beginPath();C.moveTo(v,N);C.lineTo(G.x,G.y);C.stroke();g[b]=G.x;g[b+1]=G.y}C.strokeStyle=na;if(g.length){C.beginPath();C.moveTo(g[0],g[1]);i=2;for(t=g.length;i<t;i+=2)C.lineTo(g[i],g[i+1]);C.closePath();C.stroke()}}}}}var z=0,w=0,O=0,T=0,u=0,q=0,p,E,L,C,ua,V=new P(200,190,180),ra=
V.adjustLightness(0.8),Z=V.adjustLightness(1.2),Ga=V+"",Ha=ra+"",na=Z+"",ma,F,A,aa=1,wa,R=1,qa=ta,va=20,ka,ca,da,ba,xa,Ia={container:null,items:[],init:function(a){var c=this.container=pa.createElement("DIV");c.style.pointerEvents="none";c.style.position="absolute";c.style.left=0;c.style.top=0;C=this.create();a.appendChild(c);return c},create:function(){var a=pa.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";
a.style.left=0;a.style.top=0;var c=a.getContext("2d");c.lineCap="round";c.lineJoin="round";c.lineWidth=2;try{c.mozImageSmoothingEnabled=false}catch(b){}this.items.push(a);this.container.appendChild(a);return c},setSize:function(a,c){for(var b=this.items,d=0,i=b.length;d<i;d++){b[d].width=a;b[d].height=c}}};this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){V=P.parse(a.color||a.wallColor);Ga=V.adjustAlpha(R)+"";ra=V.adjustLightness(0.8);Ha=ra.adjustAlpha(R)+"";Z=V.adjustLightness(1.2);
na=Z.adjustAlpha(R)+""}if(a.roofColor){Z=P.parse(a.roofColor);na=Z.adjustAlpha(R)+""}J();return this};this.geoJSON=function(a,c){l(a,c);return this};this.setCamOffset=function(a,c){ca=O+a;da=w+c};this.setMaxZoom=function(a){va=a};this.setDate=function(){return this};this.appendTo=function(a){return Ia.init(a)};this.loadData=f;this.onMoveEnd=function(){var a=o(u,q),c=o(u+z,q+w);J();if(F&&(a[ga]>F.n||a[ha]<F.w||c[ga]<F.s||c[ha]>F.e))f()};this.onZoomEnd=function(a){xa=false;I(a.zoom);if(ma){A=n(ma);
J()}else{J();f()}};this.onZoomStart=function(){xa=true;J()};this.setOrigin=function(a,c){u=a;q=c};this.setSize=function(a,c){z=a;w=c;O=z/2<<0;T=w/2<<0;ca=O;da=w;ba=z/((window.devicePixelRatio||1)*1.5)/za(45)<<0;Ia.setSize(z,w);ka=ba-50};this.setZoom=I;this.render=J;ua=m};k.OSMBuildings.VERSION="0.1.8a";k.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:false,alwaysInRange:true,dxSum:0,dySum:0,initialize:function(k){k=k||{};k.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize(this.name,k)},setOrigin:function(){var k=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),H=this.map.resolution,K=this.maxExtent;this.osmb.setOrigin(Math.round((k.lon-K.left)/H),Math.round((K.top-
k.lat)/H))},setMap:function(k){this.map||OpenLayers.Layer.prototype.setMap(k);if(!this.osmb){this.osmb=new OSMBuildings(this.options.url);this.container=this.osmb.appendTo(this.div)}this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()},removeMap:function(k){this.container.parentNode.removeChild(this.container);OpenLayers.Layer.prototype.removeMap(k)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize();this.osmb.onResize({width:this.map.size.w,
height:this.map.size.h})},moveTo:function(k,H,K){k=OpenLayers.Layer.prototype.moveTo(k,H,K);if(!K){K=parseInt(this.map.layerContainerDiv.style.left,10);var oa=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-K+"px";this.div.style.top=-oa+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);H?this.osmb.onZoomEnd({zoom:this.map.zoom}):this.osmb.onMoveEnd();return k},moveByPx:function(k,H){this.dxSum+=k;this.dySum+=H;var K=OpenLayers.Layer.prototype.moveByPx(k,
H);this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();return K},geoJSON:function(k,H){return this.osmb.geoJSON(k,H)},setStyle:function(k){return this.osmb.setStyle(k)},setDate:function(k){return this.osmb.setDate(k)}});
